import Head from 'next/head'
import { Container, Flex, TextField, Textarea } from 'roku-ui'
import { useEffect, useState } from 'react'
import useSWRMutation, { type SWRMutationResponse } from 'swr/mutation'
import { useDebounce } from 'usehooks-ts'
export interface ReqBody {
  messages: Message[]
  model?: string
}

export interface Message {
  role: 'system' | 'user' | 'assistant'
  content: string
}
interface Messages { messages: Message[] }

export interface ChatResp {
  id: string
  object: string
  created: number
  model: string
  usage: Usage
  choices: Choice[]
}

export interface Usage {
  prompt_tokens: number
  completion_tokens: number
  total_tokens: number
}

export interface Choice {
  message: Message
  finish_reason: string
  index: number
}

export function useChat (): SWRMutationResponse<ChatResp, Error, Messages> {
  const res = useSWRMutation('/api/translate', async (url, { arg }: { arg: Messages }) => {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        messages: arg.messages,
      }),
    })
    if (!resp.ok) {
      // eslint-disable-next-line no-console
      console.error(resp.statusText)
    }
    return await resp.json()
  })
  return res
}

export default function Home () {
  const [source, setSource] = useState('')
  const [target, setTarget] = useState('')
  const [targetLanguage, setTargetLanguage] = useState('Chinese')
  const { trigger } = useChat()

  const sourceDebounced = useDebounce(source, 1000)
  const targetLanguageDebounced = useDebounce(targetLanguage, 1000)

  useEffect(() => {
    if (sourceDebounced === '') return
    void trigger({
      messages: [
        {
          role: 'system',
          content: `translate this text to ${targetLanguageDebounced}`,
        },
        {
          role: 'user',
          content: sourceDebounced,
        },
      ],
    })?.then((res) => { setTarget(res?.choices[0].message.content ?? '') })
  }, [sourceDebounced, targetLanguageDebounced, trigger])

  return (
    <>
      <Head>
        <title>Translator GPT - Tr.GPT</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Container style={{ paddingTop: '5rem' }}>
        <Flex direction="column" gap="1rem">
          <div style={{ textAlign: 'center' }}>
            <h1 style={{
              fontSize: '2rem',
              fontWeight: 'bold',
            }}>
              Tr.GPT
            </h1>
            <p style={{
              fontSize: '0.8rem',
              fontWeight: 'normal',
              color: 'hsl(var(--r-frontground-3))',
            }}>
              Translate your text with GPT-3.5, powered by OpenAI
            </p>
          </div>
          <Flex gap="1rem" justify="between">
            <Flex direction="column" gap="1rem" style={{ width: '100%' }}>
              <h2>From</h2>
              <TextField disabled value="Auto" />
              <Textarea className="textarea" value={source} setValue={setSource} />
            </Flex>
            <Flex direction="column" gap="1rem" style={{ width: '100%' }}>
              <h2>To</h2>
              <TextField value={targetLanguage} setValue={setTargetLanguage} />
              <Textarea className="textarea" value={target} setValue={setTarget} />
            </Flex>
          </Flex>
        </Flex>
        <h2 style={{ color: 'hsl(var(--r-frontground-3))', fontSize: '0.8rem', paddingTop: '1rem' }}>{ 'Made by Jannchie<jannchie@gmail.com>' } @ { new Date().getFullYear() }</h2>
      </Container>
    </>
  )
}
